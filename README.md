# è¯­éŸ³è¯†åˆ«APIæœåŠ¡ - ChromaDBç‰ˆæœ¬

åŸºäºå¤šç”¨æˆ·é›†åˆChromaDBå‘é‡æ•°æ®åº“çš„é«˜æ€§èƒ½è¯­éŸ³è¯†åˆ«ç³»ç»Ÿï¼Œæä¾›å£°çº¹è¯†åˆ«ã€ç”¨æˆ·ç®¡ç†å’ŒéŸ³é¢‘å¤„ç†åŠŸèƒ½ã€‚

## ğŸš€ é¡¹ç›®ç‰¹æ€§

- **ğŸ¯ è¯­éŸ³è¯†åˆ«**: é«˜ç²¾åº¦çš„å£°çº¹è¯†åˆ«å’Œèº«ä»½éªŒè¯
- **ğŸ‘¥ å¤šç”¨æˆ·æ”¯æŒ**: æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹é›†åˆï¼Œæ•°æ®éš”ç¦»
- **ğŸ’¾ ChromaDBå­˜å‚¨**: åŸºäºå‘é‡æ•°æ®åº“çš„é«˜æ•ˆæ£€ç´¢
- **ğŸš€ é«˜æ€§èƒ½**: æ¯«ç§’çº§å“åº”æ—¶é—´
- **ğŸ”§ RESTful API**: æ ‡å‡†HTTPæ¥å£ï¼Œæ˜“äºé›†æˆ
- **ğŸ›¡ï¸ æ•°æ®å®‰å…¨**: æœ¬åœ°å­˜å‚¨ï¼Œéšç§ä¿æŠ¤
- **ğŸ“Š ç»Ÿè®¡åˆ†æ**: å®Œæ•´çš„ç”¨æˆ·å’Œç³»ç»Ÿç»Ÿè®¡åŠŸèƒ½

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- Python 3.8+
- ä¾èµ–åŒ…è§ `requirements.txt`
- Windows/Linux/macOS

## ğŸ› ï¸ å®‰è£…é…ç½®

### 1. å…‹éš†é¡¹ç›®
```bash
git clone <repository-url>
cd le_bot_vpr
```

### 2. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 3. ç¯å¢ƒå˜é‡é…ç½® (å¯é€‰)
```bash
# APIé…ç½®
export API_HOST="0.0.0.0"
export API_PORT="8000"
export API_DEBUG="false"

# ChromaDBé…ç½®
export CHROMA_PERSIST_DIR="./voice_chroma_db"

# ç¼“å­˜é…ç½®
export CACHE_TIMEOUT="300"
export LAZY_LOAD="true"
```

## ğŸš€ å¯åŠ¨æœåŠ¡

### å¼€å‘æ¨¡å¼å¯åŠ¨
```bash
python run_server.py
```

### ç”Ÿäº§æ¨¡å¼å¯åŠ¨
```bash
# ä½¿ç”¨Gunicorn (æ¨è)
pip install gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000

# æˆ–ä½¿ç”¨uvicornç›´æ¥å¯åŠ¨
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### è‡ªå®šä¹‰é…ç½®å¯åŠ¨
```bash
python run_server.py --host 0.0.0.0 --port 8080 --debug
```

æœåŠ¡å¯åŠ¨åè®¿é—®ï¼š
- APIæœåŠ¡: http://localhost:8000
- APIæ–‡æ¡£: http://localhost:8000/docs
- å¥åº·æ£€æŸ¥: http://localhost:8000/health

## ğŸ“¡ APIæ¥å£æ–‡æ¡£

### åŸºç¡€ä¿¡æ¯

- **åŸºç¡€URL**: `http://localhost:8000/api/v4/vpr`
- **è¯·æ±‚æ ¼å¼**: `multipart/form-data` (æ–‡ä»¶ä¸Šä¼ )
- **å“åº”æ ¼å¼**: `application/json`
- **å­—ç¬¦ç¼–ç **: UTF-8

### 1. æ³¨å†Œç”¨æˆ·éŸ³é¢‘

æ³¨å†Œç”¨æˆ·çš„è¯­éŸ³ç‰¹å¾åˆ°ç³»ç»Ÿä¸­ã€‚

**æ¥å£**: `POST /api/v4/vpr/register`

**å‚æ•°**:
- `file` (file): éŸ³é¢‘æ–‡ä»¶ï¼Œæ”¯æŒæ ¼å¼: .wav, .mp3, .flac, .m4a, .ogg, .aac
- `user_id` (string): ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `person_name` (string): äººå‘˜å§“å
- `relationship` (string): ä¸ç”¨æˆ·çš„å…³ç³»ï¼Œé»˜è®¤: "æœ‹å‹"

**ç¤ºä¾‹è¯·æ±‚**:
```bash
curl -X POST http://localhost:8000/api/v4/vpr/register \
  -F "file=@audio.wav" \
  -F "user_id=user001" \
  -F "person_name=å¼ ä¸‰" \
  -F "relationship=æœ¬äºº"
```

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "message": "æˆåŠŸæ³¨å†Œ å¼ ä¸‰ (æœ¬äºº) éŸ³é¢‘ç‰¹å¾",
  "user_id": "user001",
  "person_name": "å¼ ä¸‰",
  "voice_id": null,
  "registration_time": "2025-11-19 20:43:36"
}
```

### 2. è¯­éŸ³è¯†åˆ«

è¯†åˆ«ä¸Šä¼ çš„éŸ³é¢‘å¯¹åº”çš„ç”¨æˆ·èº«ä»½ã€‚

**æ¥å£**: `POST /api/v4/vpr/recognize`

**å‚æ•°**:
- `file` (file): éŸ³é¢‘æ–‡ä»¶
- `user_id` (string, å¯é€‰): æŒ‡å®šåœ¨ç‰¹å®šç”¨æˆ·ä¸‹æœç´¢
- `threshold` (float): è¯†åˆ«é˜ˆå€¼ï¼ŒèŒƒå›´ 0.0-1.0ï¼Œé»˜è®¤: 0.6

**ç¤ºä¾‹è¯·æ±‚**:
```bash
curl -X POST http://localhost:8000/api/v4/vpr/recognize \
  -F "file=@test_audio.wav" \
  -F "user_id=user001" \
  -F "threshold=0.3"
```

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "message": "æˆåŠŸè¯†åˆ«: å¼ ä¸‰ (æœ¬äºº)",
  "user_id": "user001",
  "voice_id": "user001_å¼ ä¸‰_1663556282",
  "person_id": "user001_å¼ ä¸‰_1663556282",
  "person_name": "å¼ ä¸‰",
  "is_user": true,
  "confidence": 1.0,
  "similarity": 1.0,
  "processing_time_ms": 126.41,
  "match_details": {}
}
```

### 3. è·å–ç”¨æˆ·åˆ—è¡¨

è·å–æ‰€æœ‰å·²æ³¨å†Œçš„ç”¨æˆ·åŠå…¶ç»Ÿè®¡ä¿¡æ¯ã€‚

**æ¥å£**: `GET /api/v4/vpr/users`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "users": [
    {
      "user_id": "user001",
      "user_name": null,
      "total_persons": 3,
      "total_audio_features": 5,
      "persons": []
    }
  ],
  "count": 1
}
```

### 4. è·å–ç”¨æˆ·äººå‘˜åˆ—è¡¨

è·å–æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰äººå‘˜ä¿¡æ¯ã€‚

**æ¥å£**: `GET /api/v4/vpr/users/{user_id}/persons`

**ç¤ºä¾‹å“åº”**:
```json
[
  {
    "person_id": "user001_å¼ ä¸‰_1663556282",
    "person_name": "å¼ ä¸‰",
    "audio_count": 3,
    "created_at": "2025-11-19T20:43:36.374385"
  }
]
```

### 5. è·å–ç”¨æˆ·ç»Ÿè®¡

è·å–æŒ‡å®šç”¨æˆ·çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ã€‚

**æ¥å£**: `GET /api/v4/vpr/stats/{user_id}`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "stats": {
    "user_id": "user001",
    "user_audio_count": 2,
    "total_persons": 2,
    "total_audio_features": 6,
    "persons_detail": [
      {
        "person_id": "user001_å¼ ä¸‰_1663556364",
        "person_name": "å¼ ä¸‰",
        "audio_count": 2,
        "created_at": "2025-11-19T20:44:17.981238"
      }
    ],
    "last_updated": "2025-11-19T12:46:04.781949"
  },
  "message": "ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ"
}
```

### 6. è·å–å…¨å±€ç»Ÿè®¡

è·å–æ•´ä¸ªç³»ç»Ÿçš„ç»Ÿè®¡ä¿¡æ¯ã€‚

**æ¥å£**: `GET /api/v4/vpr/stats`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "stats": {
    "total_users": 10,
    "total_persons": 25,
    "total_audio_features": 50,
    "last_updated": "2025-11-19T12:46:09.011458",
    "storage_info": {
      "storage_type": "single_collection_per_user",
      "total_users": 10,
      "base_directory": "./voice_chroma_db",
      "hnsw_space": "cosine",
      "collections_per_user": 1
    },
    "cache_status": {
      "cached_users": 5,
      "cache_timeout": 300
    }
  },
  "message": "å…¨å±€ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ"
}
```

### 7. è·å–å­˜å‚¨ä¿¡æ¯

è·å–ChromaDBå­˜å‚¨ç³»ç»Ÿä¿¡æ¯ã€‚

**æ¥å£**: `GET /api/v4/vpr/storage/info`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "storage_info": {
    "storage_type": "single_collection_per_user",
    "total_users": 10,
    "base_directory": "./voice_chroma_db",
    "hnsw_space": "cosine",
    "collections_per_user": 1
  }
}
```

### 8. æ¸…ç©ºç¼“å­˜

æ¸…ç©ºå†…å­˜ç¼“å­˜ä»¥é‡Šæ”¾èµ„æºã€‚

**æ¥å£**: `POST /api/v4/vpr/cache/clear`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "message": "å†…å­˜ç¼“å­˜å·²æ¸…ç©º"
}
```

### 9. åˆ é™¤ç”¨æˆ·

åˆ é™¤æŒ‡å®šç”¨æˆ·åŠå…¶æ‰€æœ‰æ•°æ®ï¼ˆè°¨æ…æ“ä½œï¼‰ã€‚

**æ¥å£**: `DELETE /api/v4/vpr/users/{user_id}`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "message": "ç”¨æˆ· user001 åŠå…¶æ‰€æœ‰æ•°æ®å·²åˆ é™¤"
}
```

### 10. åˆ é™¤ç”¨æˆ·äººå‘˜

åˆ é™¤ç”¨æˆ·ä¸‹çš„ç‰¹å®šäººå‘˜åŠå…¶æ‰€æœ‰éŸ³é¢‘ã€‚

**æ¥å£**: `DELETE /api/v4/vpr/users/{user_id}/persons/{person_id}`

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "message": "äººå‘˜ å¼ ä¸‰ åŠå…¶æ‰€æœ‰éŸ³é¢‘å·²åˆ é™¤"
}
```

## ğŸ”§ å¼€å‘å’Œæµ‹è¯•

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡ŒHTTP APIæµ‹è¯•
python test_chroma_windows.py

# è¿è¡Œå…¶ä»–æµ‹è¯•
python test_simple_chroma.py
python test_multi_collection_chroma.py
```

### ç¯å¢ƒæ£€æŸ¥
```bash
# æ£€æŸ¥ç¯å¢ƒå’Œä¾èµ–
python run_server.py --check-only
```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è°ƒè¯•æ¨¡å¼
python run_server.py --debug
```

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
è¯­éŸ³è¯†åˆ«APIç³»ç»Ÿ
â”œâ”€â”€ APIå±‚ (FastAPI)
â”‚   â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ å¤„ç†
â”‚   â”œâ”€â”€ å‚æ•°éªŒè¯
â”‚   â””â”€â”€ å“åº”æ ¼å¼åŒ–
â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ è¯­éŸ³ç‰¹å¾æå–
â”‚   â”œâ”€â”€ ç›¸ä¼¼åº¦è®¡ç®—
â”‚   â””â”€â”€ ç”¨æˆ·ç®¡ç†
â”œâ”€â”€ æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ ChromaDBå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ å‘é‡æ£€ç´¢
â””â”€â”€ å­˜å‚¨å±‚
    â”œâ”€â”€ å‘é‡æ•°æ®åº“ (ChromaDB)
    â”œâ”€â”€ æ–‡ä»¶å­˜å‚¨
    â””â”€â”€ ç¼“å­˜å­˜å‚¨
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### è¯­éŸ³è¯†åˆ«æµç¨‹
1. **éŸ³é¢‘é¢„å¤„ç†**: æ ¼å¼éªŒè¯ã€é™å™ªå¤„ç†
2. **ç‰¹å¾æå–**: ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹æå–å£°çº¹ç‰¹å¾
3. **å‘é‡å­˜å‚¨**: å°†ç‰¹å¾å‘é‡å­˜å‚¨åˆ°ChromaDB
4. **ç›¸ä¼¼åº¦è®¡ç®—**: ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œèº«ä»½åŒ¹é…
5. **ç»“æœè¿”å›**: è¿”å›è¯†åˆ«ç»“æœå’Œç½®ä¿¡åº¦

### å¤šç”¨æˆ·æ¶æ„
- æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„å‘é‡é›†åˆ
- æ•°æ®å®Œå…¨éš”ç¦»ï¼Œç¡®ä¿éšç§å®‰å…¨
- æ”¯æŒç”¨æˆ·çº§çš„CRUDæ“ä½œ
- é«˜æ•ˆçš„è·¨ç”¨æˆ·æœç´¢èƒ½åŠ›

### æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜æœºåˆ¶**: å†…å­˜ç¼“å­˜çƒ­ç‚¹æ•°æ®
- **æ‡’åŠ è½½**: æŒ‰éœ€åŠ è½½ç”¨æˆ·æ•°æ®
- **å‘é‡ç´¢å¼•**: HNSWç´¢å¼•åŠ é€Ÿæ£€ç´¢
- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šç”¨æˆ·å¹¶å‘æ“ä½œ

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- **æœ¬åœ°å­˜å‚¨**: æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸ä¸Šä¼ äº‘ç«¯
- **æ•°æ®éš”ç¦»**: ç”¨æˆ·é—´æ•°æ®å®Œå…¨éš”ç¦»
- **æƒé™æ§åˆ¶**: åŸºäºuser_idçš„è®¿é—®æ§åˆ¶
- **æ ¼å¼éªŒè¯**: ä¸¥æ ¼çš„æ–‡ä»¶æ ¼å¼éªŒè¯

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **å“åº”æ—¶é—´**: é€šå¸¸ < 200ms
- **è¯†åˆ«å‡†ç¡®ç‡**: > 95%
- **å¹¶å‘æ”¯æŒ**: 100+ å¹¶å‘è¯·æ±‚
- **å­˜å‚¨æ•ˆç‡**: æ¯ä¸ªéŸ³é¢‘çº¦1KBå‘é‡æ•°æ®

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -ano | findstr :8000

   # æ£€æŸ¥ä¾èµ–å®‰è£…
   pip install -r requirements.txt
   ```

2. **éŸ³é¢‘è¯†åˆ«å¤±è´¥**
   ```bash
   # æ£€æŸ¥éŸ³é¢‘æ ¼å¼æ˜¯å¦æ”¯æŒ
   # ç¡®ä¿éŸ³é¢‘æ–‡ä»¶ä¸ä¸ºç©º
   # æ£€æŸ¥é‡‡æ ·ç‡æ˜¯å¦ä¸º16kHz
   ```

3. **æ•°æ®åº“è¿æ¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥ChromaDBæƒé™
   # ç¡®è®¤å­˜å‚¨ç›®å½•å­˜åœ¨ä¸”å¯å†™
   # æ£€æŸ¥ç£ç›˜ç©ºé—´
   ```

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹APIæ—¥å¿—
tail -f api.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f error.log
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ“ è”ç³»æ–¹å¼

- é¡¹ç›®ä¸»é¡µ: [GitHub Repository]
- é—®é¢˜åé¦ˆ: [GitHub Issues]
- æŠ€æœ¯æ–‡æ¡£: [Wiki]

## ğŸ”„ ç‰ˆæœ¬å†å²

- **v5.0.0** - ChromaDBå¤šç”¨æˆ·é›†åˆç‰ˆæœ¬
  - å®Œæ•´çš„å¤šç”¨æˆ·æ”¯æŒ
  - HTTP APIæ¥å£
  - é«˜æ€§èƒ½å‘é‡æ£€ç´¢

- **v4.0.0** - ChromaDBåŸºç¡€ç‰ˆæœ¬
  - ChromaDBé›†æˆ
  - åŸºç¡€è¯†åˆ«åŠŸèƒ½

- **v3.0.0** - MongoDBä¼˜åŒ–ç‰ˆæœ¬
  - æ€§èƒ½ä¼˜åŒ–
  - ç¼“å­˜æœºåˆ¶

- **v2.0.0** - MongoDBç‰ˆæœ¬
  - æ•°æ®åº“æ”¯æŒ
  - ç”¨æˆ·ç®¡ç†

- **v1.0.0** - åˆå§‹ç‰ˆæœ¬
  - åŸºç¡€è¯†åˆ«åŠŸèƒ½

---

**æ³¨æ„**: æœ¬ç³»ç»Ÿä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶ç›®çš„ï¼Œè¯·ç¡®ä¿åœ¨åˆè§„çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚